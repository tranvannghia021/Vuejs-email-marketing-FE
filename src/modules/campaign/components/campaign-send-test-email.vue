<template>
	<vue-modal
		v-model="toggleSendTest"
		:closeable="false">
		<template slot="header">
			<div class="send-test-header">
				<svg
					width="50"
					height="50"
					viewBox="0 0 50 50"
					fill="none"
					xmlns="http://www.w3.org/2000/svg">
					<path
						d="M49.9347 0.430266C49.7766 0.0814394 49.3763 -0.0869193 49.0166 0.0446231L3.80191 16.5485C3.46813 16.6702 3.26998 17.0141 3.3318 17.364C3.39371 17.7139 3.69772 17.9689 4.05309 17.9689H18.9207C18.9207 17.9689 21.7071 28.369 21.708 28.3719C21.743 28.4968 21.8106 28.614 21.9123 28.7091C22.0535 28.8411 22.2331 28.9064 22.4122 28.9064C22.608 28.9064 22.8033 28.8284 22.9474 28.6741C22.9644 28.6559 29.248 21.8695 29.4231 21.6724C29.4505 21.6415 29.4769 21.6116 29.5027 21.5822H43.2131C43.5363 21.5822 43.8213 21.3704 43.9145 21.0608L49.9691 0.943741C49.9692 0.943252 49.9693 0.942666 49.9695 0.942178C49.9693 0.942276 49.969 0.942374 49.9688 0.942471C50.0177 0.778409 50.0104 0.597258 49.9347 0.430266ZM23.42 20.2778C23.2899 20.3817 23.1942 20.5301 23.159 20.7061L22.3089 24.9567L20.3292 17.5661C20.9633 17.1938 22.5281 16.3042 26.2762 14.2234C26.6299 14.027 26.7574 13.5812 26.5611 13.2275C26.3646 12.874 25.919 12.7464 25.5652 12.9426C23.5615 14.0551 19.3517 16.4424 19.2549 16.504H8.19565L40.4684 4.72419C36.6054 6.84616 32.0311 9.36314 28.1304 11.5211C27.7765 11.7169 27.6483 12.1625 27.8441 12.5165C28.0398 12.8705 28.4856 12.9988 28.8395 12.8029C33.0242 10.4877 37.9844 7.75934 42.0093 5.549L23.4223 20.2756C23.4215 20.2763 23.4208 20.2772 23.42 20.2778ZM23.6366 25.7874L24.4777 21.582H27.5288C26.5572 22.6436 25.0496 24.2696 23.6366 25.7874ZM42.6686 20.1173H25.9809L47.894 2.75545L42.6686 20.1173Z"
						fill="#003084" />
					<path
						d="M17.6567 28.8279C17.3706 28.5419 16.9069 28.5419 16.6209 28.8279L10.2201 35.2287C10.2427 34.8975 10.2541 34.5637 10.2541 34.2286C10.2541 32.9477 9.71681 31.7115 8.7801 30.8371C7.8301 29.9504 6.58978 29.5119 5.28802 29.6013C2.99477 29.7595 1.14624 31.608 0.98804 33.9013C0.898294 35.2032 1.33716 36.4434 2.22387 37.3933C3.09829 38.3301 4.33441 38.8674 5.61537 38.8674C6.47269 38.8674 7.30764 38.7213 8.09162 38.4408C7.46077 40.2797 6.4137 41.9648 4.99857 43.3798L3.43725 44.9412C3.15122 45.2273 3.15122 45.691 3.43725 45.977C3.58031 46.12 3.76781 46.1915 3.95522 46.1915C4.14262 46.1915 4.33012 46.12 4.47318 45.977L6.0345 44.4157C7.96692 42.4832 9.28293 40.0981 9.88322 37.4997C10.2068 37.2673 10.5138 37.0066 10.8011 36.7194L17.6566 29.8639C17.9428 29.5777 17.9428 29.114 17.6567 28.8279ZM8.57278 36.6058C7.68489 37.1254 6.67142 37.4024 5.61546 37.4024C4.72621 37.4024 3.90199 37.0442 3.29477 36.3937C2.68813 35.7438 2.38794 34.8943 2.44946 34.002C2.55747 32.4344 3.82123 31.1707 5.3888 31.0626C5.46527 31.0573 5.54134 31.0547 5.61693 31.0547C6.42513 31.0547 7.18626 31.3532 7.78059 31.9079C8.43108 32.5151 8.78928 33.3393 8.78928 34.2286C8.78918 35.0349 8.71594 35.8296 8.57278 36.6058Z"
						fill="#003084" />
					<path
						d="M38.8751 26.2274C38.5303 26.0158 38.0793 26.1239 37.8678 26.4687L34.619 31.7646C34.6008 31.6801 34.5817 31.5957 34.5615 31.5112C34.3282 30.5378 33.6948 29.6962 32.8237 29.2022C31.9401 28.7013 30.9179 28.5935 29.9451 28.8987C28.2309 29.4365 27.1625 31.1782 27.46 32.9499C27.6288 33.9555 28.1881 34.8179 29.0349 35.3784C29.87 35.931 30.9073 36.114 31.8808 35.8811C32.3882 35.7596 32.8685 35.5718 33.3124 35.3249C33.1377 36.5953 32.6996 37.827 32.0089 38.9529L31.1539 40.3466C30.9424 40.6914 31.0504 41.1423 31.3952 41.3538C31.5147 41.4271 31.6469 41.462 31.7775 41.462C32.0237 41.462 32.2642 41.3378 32.4024 41.1125L33.2574 39.7188C34.3219 37.9835 34.8674 36.0303 34.8643 34.0446C35.0458 33.8292 35.2123 33.5986 35.3623 33.3541L39.1163 27.2345C39.3278 26.8898 39.2198 26.4389 38.8751 26.2274ZM31.5394 34.4567C30.9509 34.5977 30.3485 34.4913 29.8433 34.157C29.3388 33.823 29.0054 33.3084 28.9046 32.7076C28.7275 31.6531 29.3634 30.6166 30.3837 30.2966C30.6008 30.2285 30.8219 30.1947 31.0411 30.1947C31.4089 30.1947 31.7715 30.2897 32.1011 30.4767C32.628 30.7755 32.9958 31.2642 33.1368 31.8528C33.2662 32.3929 33.3473 32.937 33.381 33.4799C32.8667 33.9528 32.2377 34.2894 31.5394 34.4567Z"
						fill="#003084" />
					<path
						d="M2.89564 46.9773C2.60179 46.6997 2.13812 46.7126 1.86039 47.0069L0.200239 48.7647C-0.0775916 49.0587 -0.0643104 49.5223 0.229829 49.8C0.371332 49.9337 0.552093 50 0.732562 50C0.926994 50 1.12113 49.9231 1.26508 49.7705L2.92523 48.0126C3.20306 47.7186 3.18978 47.255 2.89564 46.9773Z"
						fill="#003084" />
					<path
						d="M21.3703 37.5368C21.0399 37.3031 20.583 37.3816 20.3494 37.7118L17.5173 41.7157C17.2838 42.046 17.3621 42.5031 17.6923 42.7366C17.8208 42.8275 17.9684 42.8712 18.1146 42.8712C18.3444 42.8712 18.5705 42.7634 18.7132 42.5616L21.5453 38.5577C21.7789 38.2275 21.7005 37.7703 21.3703 37.5368Z"
						fill="#003084" />
				</svg>
				<div class="modal-title-group">
					<h1 class="modal-title">Send test email</h1>
					<div class="modal-subtitle">
						Please enter your email to receive template test
					</div>
				</div>
			</div>
		</template>
		<div class="send-test-body">
			<vue-input
				placeholder="Enter your email"
				v-model="email"></vue-input>
		</div>
		<div class="send-test-footer">
			<div class="flex flex-row-end flex-gap-16 gap-59">
				<vue-button
					@clicked="toggleModalSendTest"
					class="btn-outline btn-cancel"
					>No, Cancel</vue-button
				>
				<vue-button
					:is_loading="is_loading"
					@clicked="handleSendTestEmail"
					class="btn-primary btn-send"
					>Send</vue-button
				>
			</div>
		</div>
	</vue-modal>
</template>

<script>
	import VueButton from '@/components/vue-button.vue';
	import VueInput from '@/components/vue-input.vue';
	import VueModal from '@/components/vue-modal.vue';
	import { mapActions, mapState, mapGetters } from 'vuex';
	import store from '@/store';
	import mixins from '@/plugins/mixins';

	export default {
		name: 'campaign-send-test-email',
		props: ['value'],
		components: {
			VueButton,
			VueInput,
			VueModal,
		},
		mixins: [mixins],
		data() {
			return {
				email: '',
				is_loading: false,
			};
		},
		computed: {
			...mapState('campaign', ['new_campaign']),
			...mapGetters('campaign', [
				'background_email',
				'background_button',
				'text_color_button',
			]),
			toggleSendTest: {
				get() {
					return this.value;
				},
				set(value) {
					this.$emit('input', value);
				},
			},
		},
		methods: {
			...mapActions({
				sendEmailTest: 'campaign/SendEmailTest',
			}),
			toggleModalSendTest() {
				this.toggleSendTest = !this.toggleSendTest;
			},
			async handleSendTestEmail() {
				//validate subject email
				if (
					!this.new_campaign.subject ||
					this.new_campaign.subject == '<p></p>'
				) {
					store.dispatch('notification/add', {
						type: 'error',
						message: 'Subject email is empty',
					});
					return;
				}
				//validate content email
				if (
					!this.new_campaign.email_content ||
					this.new_campaign.email_content == '<p></p>' ||
					this.new_campaign.email_content == '<p><br/></p>'
				) {
					store.dispatch('notification/add', {
						type: 'error',
						message: 'Content email is empty',
					});
					return;
				}
				//validate image email
				if (!this.new_campaign.email_custom.image) {
					store.dispatch('notification/add', {
						type: 'error',
						message: 'Image is empty',
					});
					return;
				}
				// delete space to validate list email, send to backend
				let list_email = this.email.replaceAll(' ', '');
				// list email typeof string to array
				let arr_email = list_email.split(',');
				// delete elements contains "''" in array
				arr_email = arr_email.filter(function (value) {
					return value != '';
				});
				if (arr_email.length <= 0) {
					store.dispatch('notification/add', {
						type: 'error',
						message: 'List email is empty',
					});
					return;
				}
				for (let email of arr_email) {
					//validate list email, if email wrong will notification
					if (!this.ValidateEmail(email)) {
						store.dispatch('notification/add', {
							type: 'error',
							message: `Email "${email}" is wrong. Please check again.`,
						});
						return;
					}
				}
				// limit 5 email
				if (arr_email.length > 5) {
					store.dispatch('notification/add', {
						type: 'error',
						message: `Only 5 emails allowed`,
					});
					return;
				}
				this.is_loading = true;
				// format subject (html to plain text, replace variant)
				let subject = this.handleSubject(this.new_campaign.subject);
				// create body email
				let body = this.handleBodyEmail({
					background_email_color: this.background_email,
					background_email_radius:
						this.new_campaign.email_custom.background.radius.size +
						this.new_campaign.email_custom.background.radius.unit,
					email_content: this.new_campaign.email_content,
					button_label: this.new_campaign.email_custom.button.label,
					background_button: this.background_button,
					background_button_radius:
						this.new_campaign.email_custom.button.radius.size +
						this.new_campaign.email_custom.button.radius.unit,
					text_color_button: this.text_color_button,
					text_color:
						this.new_campaign.email_custom.background.text_color,
					email_footer: this.new_campaign.email_footer,
				});
				// handle send test email
				try {
					const res = await this.sendEmailTest({
						subject,
						image: this.new_campaign.email_custom.image,
						body,
						list: this.email,
					});
					if (res.success) {
						store.dispatch('notification/add', {
							type: 'success',
							message: res.message,
						});

						this.toggleModalSendTest();
						this.is_loading = false;
					}
				} catch (error) {
					let errors = error.data.message;
					store.dispatch('notification/add', {
						type: 'error',
						message: errors.campaign_name
							? errors.campaign_name[0]
							: errors.image
							? errors.image[0]
							: errors.subject
							? errors.subject[0]
							: errors.email_body
							? errors.email_body[0]
							: errors.list_customers
							? errors.list_customers[0]
							: errors
							? errors
							: 'Server Error',
					});
					this.is_loading = false;

					return;
				}
			},
		},
	};
</script>

<style lang="scss" scoped>
	.send-test {
		&-header {
			padding: 28px 76px 24px 44px;
		}

		&-body {
			padding: 0px 24px 59px 44px;
		}

		&-footer {
			padding: 0px 24px 24px 44px;
		}
	}
	.btn-cancel,
	.btn-send {
		padding: 0;
		font-size: 12px;
		height: 32px;
		width: 104px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.btn-cancel {
		line-height: 16px;
	}
</style>
